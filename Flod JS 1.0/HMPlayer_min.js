/*
  JavaScript Flod 1.0
  2011/11/30
  Christian Corti
  Neoart Costa Rica

  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
 	OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE
 	LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR
  IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE SOFTWARE.

  This work is licensed under the Creative Commons Attribution-Noncommercial-Share Alike 3.0 Unported License.
  To view a copy of this license, visit http://creativecommons.org/licenses/by-nc-sa/3.0/ or send a letter to
  Creative Commons, 171 Second Street, Suite 300, San Francisco, California, 94105, USA.
*/
(function(){function j(f){return Object.create(null,{index:{value:f,writable:!0},next:{value:null,writable:!0},channel:{value:null,writable:!0},sample:{value:null,writable:!0},enabled:{value:0,writable:!0},period:{value:0,writable:!0},effect:{value:0,writable:!0},param:{value:0,writable:!0},volume1:{value:0,writable:!0},volume2:{value:0,writable:!0},handler:{value:0,writable:!0},portaDir:{value:0,writable:!0},portaPeriod:{value:0,writable:!0},portaSpeed:{value:0,writable:!0},vibratoPos:{value:0,writable:!0},
vibratoSpeed:{value:0,writable:!0},wavePos:{value:0,writable:!0},initialize:{value:function(){this.sample=this.channel=null;this.wavePos=this.vibratoSpeed=this.vibratoPos=this.portaSpeed=this.portaPeriod=this.portaDir=this.handler=this.volume2=this.volume1=this.param=this.effect=this.period=this.enabled=0}}})}window.neoart.createHMPlayer=function(f){f=createAmigaPlayer(f);Object.defineProperties(f,{id:{value:"HMPlayer"},track:{value:null,writable:!0},patterns:{value:[],writable:!0},samples:{value:[],
writable:!0},length:{value:0,writable:!0},restart:{value:0,writable:!0},voices:{value:[],writable:!0},trackPos:{value:0,writable:!0},patternPos:{value:0,writable:!0},jumpFlag:{value:0,writable:!0},initialize:{value:function(){var a=this.voices[0];this.core_initialize();this.timer=6;this.jumpFlag=this.patternPos=this.trackPos=0;for(this.mixer.samplesTick=884;a;)a.initialize(),a.channel=this.mixer.channels[a.index],a.sample=this.samples[0],a=a.next}},loader:{value:function(a){var i=0,d,g,e,c=0,b,f=
0,h;if(!(2150>a.length)&&(a.position=1080,g=a.readString(4),"FEST"==g)){a.position=950;this.length=a.readUnsignedByte();this.restart=a.readUnsignedByte();for(d=0;128>d;++d)this.track[d]=a.readUnsignedByte();a.position=0;this.title=a.readString(20);for(d=this.version=1;32>d;++d){this.samples[d]=null;g=a.readString(4);if("Mupp"==g){h=a.readUnsignedByte();for(e=0;128>e;++e)this.track[e]>=h&&this.track[e]--;b=this.createSample();b.name=g;b.length=b.repeat=32;b.restart=a.readUnsignedByte();b.waveLen=a.readUnsignedByte();
a.position+=17;b.finetune=a.readByte();b.volume=a.readUnsignedByte();g=a.position+4;h=1084+(h<<10);a.position=h;b.pointer=this.mixer.memory.length;b.waves=new Uint32Array(64);b.volumes=new Uint32Array(64);this.mixer.store(a,896);for(e=0;64>e;++e)b.waves[e]=a.readUnsignedByte()<<5;for(e=0;64>e;++e)b.volumes[e]=a.readUnsignedByte()&127;a.position=h;a.writeInt(1718382436);a.position=g;c+=896}else{g=g.substr(0,2);"El"==g?a.position+=18:(a.position-=4,g=a.readString(22));h=a.readUnsignedShort();if(0==
h){a.position+=6;continue}b=this.createSample();b.name=g;b.pointer=f;b.length=h<<1;b.finetune=a.readByte();b.volume=a.readUnsignedByte();b.loop=a.readUnsignedShort()<<1;b.repeat=a.readUnsignedShort()<<1;f+=b.length}this.samples[d]=b}for(d=0;128>d;++d)h=this.track[d]<<8,this.track[d]=h,h>i&&(i=h);a.position=1084;i+=256;this.patterns=[];this.patterns.length=i;for(d=0;d<i;++d){for(h=a.readUnsignedInt();1718382436==h;)a.position+=1020,h=a.readUnsignedInt();e=this.mixer.createRow();e.note=h>>16&4095;e.sample=
h>>24&240|h>>12&15;e.effect=h>>8&15;e.param=h&255;this.patterns[d]=e}this.mixer.store(a,f);for(d=1;32>d;++d)if(b=this.samples[d],!(null==b||"Mupp"==b.name)){b.pointer+=c;b.loop?(b.loopPtr=b.pointer+b.loop,b.length=b.loop+b.repeat):(b.loopPtr=this.mixer.memory.length,b.repeat=2);f=b.pointer+4;for(e=b.pointer;e<f;++e)this.mixer.memory[e]=0}b=this.createSample();b.pointer=b.loopPtr=this.mixer.memory.length;b.length=b.repeat=2;this.samples[0]=b}}},process:{value:function(){var a,f,d,g,e,c=this.voices[0];
if(this.tick)for(;c;)this.effects(c),this.handler(c),g=c.sample,c.channel.pointer=g.loopPtr,c.channel.length=g.repeat,c=c.next;else for(f=this.track[this.trackPos]+this.patternPos;c;){a=c.channel;c.enabled=0;d=this.patterns[f+c.index];c.effect=d.effect;c.param=d.param;d.sample?(g=c.sample=this.samples[d.sample],c.volume2=g.volume,"Mupp"==g.name?(g.loopPtr=g.pointer+g.waves[0],c.handler=1,c.volume1=g.volumes[0]):(c.handler=0,c.volume1=64)):g=c.sample;if(d.note){3==c.effect||5==c.effect?d.note<c.period?
(c.portaDir=1,c.portaPeriod=d.note):d.note>c.period?(c.portaDir=0,c.portaPeriod=d.note):c.portaPeriod=0:(c.period=d.note,c.vibratoPos=0,c.wavePos=0,c.enabled=1,a.enabled=0,e=c.period*g.finetune>>8,a.period=c.period+e,c.handler?(a.pointer=g.loopPtr,a.length=g.repeat):(a.pointer=g.pointer,a.length=g.length));switch(c.effect){case 11:this.trackPos=c.param-1;this.jumpFlag=1;break;case 12:c.volume2=c.param;if(64<c.volume2)c.volume2=64;break;case 13:this.jumpFlag=1;break;case 14:this.mixer.filter.active=
c.param^1;break;case 15:e=c.param,1>e?e=1:31<e&&(e=31),this.timer=e,this.tick=0}0==d.note&&this.effects(c);this.handler(c);if(c.enabled)a.enabled=1;a.pointer=g.loopPtr;a.length=g.repeat}c=c.next}if(++this.tick==this.timer&&(this.tick=0,this.patternPos+=4,256==this.patternPos||this.jumpFlag))if(this.patternPos=this.jumpFlag=0,this.trackPos=++this.trackPos&127,this.trackPos==this.length)this.trackPos=this.restart,this.mixer.complete=1}},effects:{value:function(a){var f=a.channel,d,g,e=a.period&4095,
c,b;if(a.effect||a.param)switch(a.effect){case 0:b=l[this.tick];if(0==b)break;b=1==b?a.param>>4:a.param&15;g=37-b;for(d=0;d<g;++d)if(e>=k[d]){e=k[d+b];break}break;case 1:a.period-=a.param;if(113>a.period)a.period=113;e=a.period;break;case 2:a.period+=a.param;if(856<a.period)a.period=856;e=a.period;break;case 3:case 5:if(5==a.effect)c=1;else if(a.param)a.portaSpeed=a.param,a.param=0;if(a.portaPeriod)if(a.portaDir){if(a.period-=a.portaSpeed,a.period<a.portaPeriod)a.period=a.portaPeriod,a.portaPeriod=
0}else if(a.period+=a.portaSpeed,a.period>a.portaPeriod)a.period=a.portaPeriod,a.portaPeriod=0;e=a.period;break;case 4:case 6:if(6==a.effect)c=1;else if(a.param)a.vibratoSpeed=a.param;b=m[a.vibratoPos>>2&31];b=(a.vibratoSpeed&15)*b>>7;e=127<a.vibratoPos?e-b:e+b;b=a.vibratoSpeed>>2&60;a.vibratoPos=a.vibratoPos+b&255;break;case 7:b=n[(a.vibratoPos&15)+((a.param&15)<<4)];a.vibratoPos++;for(d=0;37>d&&!(e>=k[d]);++d);b+=d;35<b&&(b-=12);e=k[b];break;case 10:c=1}f.period=e+(e*a.sample.finetune>>8);if(c)if(b=
a.param>>4,a.volume2=b?a.volume2+b:a.volume2-(a.param&15),64<a.volume2)a.volume2=64;else if(0>a.volume2)a.volume2=0}},handler:{value:function(a){var f;if(a.handler&&(f=a.sample,f.loopPtr=f.pointer+f.waves[a.wavePos],a.volume1=f.volumes[a.wavePos],++a.wavePos>f.waveLen))a.wavePos=f.restart;a.channel.volume=a.volume1*a.volume2>>6}},createSample:{value:function(){var a=this.mixer.createSample();Object.defineProperties(a,{finetune:{value:0,writable:!0},restart:{value:0,writable:!0},waveLen:{value:0,writable:!0},
waves:{value:null,writable:!0},volumes:{value:null,writable:!0}});return a}}});f.track=new Uint32Array(128);f.voices[0]=j(0);f.voices[0].next=f.voices[1]=j(1);f.voices[1].next=f.voices[2]=j(2);f.voices[2].next=f.voices[3]=j(3);return Object.seal(f)};var l=[0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1,2,0,1],n=[0,3,7,12,15,12,7,3,0,3,7,12,15,12,7,3,0,4,7,12,16,12,7,4,0,4,7,12,16,12,7,4,0,3,8,12,15,12,8,3,0,3,8,12,15,12,8,3,0,4,8,12,16,12,8,4,0,4,8,12,16,12,8,4,0,5,8,12,17,12,8,5,0,5,8,
12,17,12,8,5,0,5,9,12,17,12,9,5,0,5,9,12,17,12,9,5,12,0,7,0,3,0,7,0,12,0,7,0,3,0,7,0,12,0,7,0,4,0,7,0,12,0,7,0,4,0,7,0,0,3,7,3,7,12,7,12,15,12,7,12,7,3,7,3,0,4,7,4,7,12,7,12,16,12,7,12,7,4,7,4,31,27,24,19,15,12,7,3,0,3,7,12,15,19,24,27,31,28,24,19,16,12,7,4,0,4,7,12,16,19,24,28,0,12,0,12,0,12,0,12,0,12,0,12,0,12,0,12,0,12,24,12,0,12,24,12,0,12,24,12,0,12,24,12,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,3,0,4,0,4,0,4,0,4,0,4,0,4,0,4,0,4],k=[856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,
302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,0],m=[0,24,49,74,97,120,141,161,180,197,212,224,235,244,250,253,255,253,250,244,235,224,212,197,180,161,141,120,97,74,49,24]})();